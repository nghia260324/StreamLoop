<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>üé¨ Qu·∫£n l√Ω Video Stream</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>

    <h2>T·∫£i video l√™n</h2>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="video" multiple required />
        <button type="submit">T·∫£i l√™n</button>
    </form>

    <h2>Danh s√°ch video</h2>
    <ul id="video-list">
    </ul>
    <div>
        <p id="stream-status">‚èπÔ∏è Stream ch∆∞a b·∫Øt ƒë·∫ßu</p>
        <button id="start-btn">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Live</button>
        <button id="stop-btn">‚èπÔ∏è D·ª´ng Live</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            document.getElementById("start-btn").addEventListener("click", async () => {
                const res = await fetch("/start", { method: "POST" });
                const msg = await res.text();
                document.getElementById("stream-status").textContent = "üî¥ ƒêang livestream";
                alert(msg);
            });

            document.getElementById("stop-btn").addEventListener("click", async () => {
                const res = await fetch("/stop", { method: "POST" });
                const msg = await res.text();
                document.getElementById("stream-status").textContent = "‚èπÔ∏è Stream ƒë√£ d·ª´ng";
                alert(msg);
            });

            updateVideoList();
        });

        async function updateVideoList() {
            const res = await fetch('/videos');
            const videos = await res.json();
            const listEl = document.getElementById('video-list');
            listEl.innerHTML = '';

            if (!videos.length) {
                listEl.innerHTML = '<li>Kh√¥ng c√≥ video n√†o.</li>';
                return;
            }

            videos.forEach(video => {
                const li = document.createElement('li');
                li.innerHTML = `
    ID: ${video.id}, T√™n: ${video.name}
    <button onclick="deleteVideo(${video.id})">Xo√°</button>
    <button onclick="selectVideo('${video.id}')">Ch·ªçn ƒë·ªÉ Live</button>
    ${video.selected ? '<span>‚úÖ ƒê√£ ch·ªçn</span>' : ''}
  `;
                listEl.appendChild(li);
            });
        }

        async function deleteVideo(filename) {
            const res = await fetch('/delete/' + filename, { method: 'POST' });
            if (res.ok) {
                updateVideoList();
            }
        }

        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                e.target.reset();
                updateVideoList();
            }
        });
        async function selectVideo(id) {
            try {
                const res = await fetch(`/select/${id}`, {
                    method: "POST"
                });

                if (!res.ok) {
                    const msg = await res.text();
                    alert("‚ùå L·ªói: " + msg);
                    return;
                }

                const msg = await res.text();
                alert("‚úÖ " + msg);

                // G·ªçi l·∫°i h√†m ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch video tr√™n giao di·ªán
                updateVideoList();
            } catch (err) {
                console.error("L·ªói khi ch·ªçn video:", err);
                alert("‚ùå Kh√¥ng th·ªÉ ch·ªçn video.");
            }
        }

    </script>
</body>
</html>